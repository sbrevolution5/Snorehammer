@using Snorehammer.Web.FrontendModels.Stats
<RadzenDataGrid Data="@data">
    <Columns>
        <RadzenDataGridColumn Title="Year" Width="120px">
            <Template>
                <strong>@(context.Values.All(v => v is string) ? "Company" : "Amount")</strong>
            </Template>
        </RadzenDataGridColumn>
        @foreach (var column in columns)
        {
            <RadzenDataGridColumn @key=@column.Key Title="@column.Key" Type="column.Value"
                                  Property="@PropertyAccess.GetDynamicPropertyExpression(column.Key, column.Value)">
                <Template>
                    @(context.Values.All(v => v is string) ? context[column.Key] : String.Format("{0:C}", context[column.Key]))
                </Template>
            </RadzenDataGridColumn>
        }
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter]
    public IEnumerable<MultiFightStats> stats { get; set; }
    public IEnumerable<IDictionary<string, object>> data { get; set; }
    public IDictionary<string, Type> columns { get; set; } = new Dictionary<string, Type>();
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        // crosstab query
       

        // Add dynamic columns
        foreach (var i in stats)
        {
            columns.Add(i.ColumnName.ToString(), typeof(float));
        }

        // Transpose crosstab data to "rows as columns" collection
        data = Enumerable.Range(0, stats.Count()+1).Select(i =>
        {
            var row = new Dictionary<string, object>();

            foreach (var column in columns)
            {
                var dataRow = stats.Where(d => d.ColumnName.ToString() == column.Key).FirstOrDefault();

                row.Add(
                    column.Key,
                    dataRow.AttackNumber
                );
                row.Add(
                    column.Key,
                    dataRow.AttacksHit
                );
                row.Add(
                    column.Key,
                    dataRow.WoundsInflicted
                );
                row.Add(
                    column.Key,
                    dataRow.ArmorSavesFailed
                );
                row.Add(
                    column.Key,
                    dataRow.DamageNumber
                );
                row.Add(
                    column.Key,
                    dataRow.FeelNoPainMade
                );
                row.Add(
                    column.Key,
                    dataRow.ModelsDestroyed
                );
                row.Add(
                    column.Key,
                    dataRow.UnitDamaged
                );
                row.Add(
                    column.Key,
                    dataRow.LostAModel
                );
                row.Add(
                    column.Key,
                    dataRow.LessThanHalf
                );
                row.Add(
                    column.Key,
                    dataRow.UnitEntirelyDestroyed
                );

            }

            return row;
        });
    }

    }
}
